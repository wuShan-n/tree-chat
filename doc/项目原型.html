<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深度思考工具 - 优化版原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        /* 优化：使用更现代、平滑的字体 */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            overflow: hidden;
        }
        /* 优化：对颜色进行微调，增加视觉舒适度 */
        .dark {
            --bg-primary: #111827; /* 更深的蓝灰色背景 */
            --bg-secondary: #1f2937; /* 面板和节点的背景 */
            --bg-tertiary: #374151; /* 交互元素背景 */
            --text-primary: #f9fafb; /* 主文本 */
            --text-secondary: #9ca3af; /* 次要文本 */
            --border-primary: #374151; /* 边框 */
            --accent: #3b82f6; /* 主题色调整为更鲜艳的蓝色 */
            --accent-hover: #2563eb;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        .node {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: absolute; /* 确保JS可以定位 */
        }
        .node:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }
        .node.active {
            box-shadow: 0 0 0 2px var(--accent), 0 0 20px rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
            border-color: var(--accent);
        }
        /* 新增：为节点添加“添加子节点”按钮的样式 */
        .add-node-btn {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid var(--bg-secondary);
        }
        .node:hover .add-node-btn {
            opacity: 1;
            transform: translateX(-50%) scale(1.1);
        }
        .add-node-btn:hover {
             background-color: var(--accent-hover);
        }

        #interaction-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #interaction-panel.open {
            transform: translateX(0);
        }
        /* 优化：聊天气泡样式，使其更有区分度 */
        .chat-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }
        .nudge {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* 优化：引用胶囊样式，更醒目 */
        .reference-capsule {
            background-color: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: var(--accent);
            padding: 2px 10px;
            border-radius: 9999px;
            cursor: pointer;
            display: inline-flex; /* 改为flex布局 */
            align-items: center;
            gap: 4px;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .reference-capsule:hover {
            background-color: rgba(59, 130, 246, 0.3);
        }
        /* 优化：展开的上下文样式，更清晰地体现“透明可控”原则 */
        .reference-context {
            background-color: var(--bg-primary);
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            margin: 8px 0;
            font-style: italic;
        }
        /* 优化：画布网格背景 */
        .bg-grid-pattern {
             background-image:
                linear-gradient(rgba(255,255,255,0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.07) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-[--bg-primary] text-[--text-primary] h-screen flex flex-col">

    <!-- 优化：顶部栏增加项目icon和更清晰的布局 -->
    <header class="bg-[--bg-secondary] border-b border-[--border-primary] p-2 flex items-center justify-between flex-shrink-0 h-14">
        <div class="flex items-center gap-3">
            <i data-lucide="brain-circuit" class="text-[--accent] w-7 h-7"></i>
            <div>
                <h1 class="font-bold text-lg leading-tight">AI教育模式颠覆性影响</h1>
                <p class="text-xs text-[--text-secondary]">项目文件</p>
            </div>
        </div>
        <button id="insight-btn" class="bg-[--accent] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[--accent-hover] transition-colors font-semibold">
            <i data-lucide="sparkles" class="w-5 h-5"></i>
            <span>全局洞察</span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex overflow-hidden relative">

        <!-- Canvas Area -->
        <div id="canvas-container" class="flex-grow flex flex-col relative">
            <!-- 优化：面包屑导航栏增加返回根节点的按钮，交互更清晰 -->
            <div class="bg-[--bg-secondary]/80 backdrop-blur-sm p-2 border-b border-[--border-primary] flex items-center justify-between flex-shrink-0 z-10">
                <div id="breadcrumbs" class="text-sm text-[--text-secondary] flex items-center gap-2">
                    <button class="hover:text-[--text-primary]">项目根</button>
                </div>
                <div class="flex items-center gap-2">
                    <button class="p-1 hover:bg-[--bg-tertiary] rounded"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
                    <button class="p-1 hover:bg-[--bg-tertiary] rounded"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                    <button class="p-1 hover:bg-[--bg-tertiary] rounded"><i data-lucide="locate-fixed" class="w-4 h-4"></i></button>
                </div>
            </div>

            <!-- Canvas -->
            <div id="canvas" class="flex-grow bg-grid-pattern overflow-auto relative p-8">
                <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" id="svg-lines"></svg>
                
                <!-- 优化：节点HTML结构，为其增加“添加节点”按钮 -->
                <div id="node-root" class="node bg-[--bg-secondary] p-4 rounded-lg border-2 border-[--accent] shadow-lg w-64" style="left: 50%; top: 100px; transform: translateX(-50%);">
                    <h3 class="font-bold text-center">课题：AI对未来教育模式的颠覆性影响</h3>
                    <div class="add-node-btn"><i data-lucide="plus" class="w-4 h-4"></i></div>
                </div>
                <div id="node-1" class="node bg-[--bg-secondary] p-3 rounded-lg border border-[--border-primary] shadow-md w-48" style="left: 20%; top: 300px;">
                    <h3 class="font-semibold">正面影响</h3>
                    <p class="text-xs text-[--text-secondary] mt-1 line-clamp-2">结论：实现个性化学习路径，提升教学效率...</p>
                    <div class="add-node-btn"><i data-lucide="plus" class="w-4 h-4"></i></div>
                </div>
                <div id="node-2" class="node bg-[--bg-secondary] p-3 rounded-lg border border-[--border-primary] shadow-md w-48" style="left: 40%; top: 300px;">
                    <h3 class="font-semibold">负面影响</h3>
                    <p class="text-xs text-[--text-secondary] mt-1 line-clamp-2">结论：可能加剧教育不公，产生技术依赖...</p>
                    <div class="add-node-btn"><i data-lucide="plus" class="w-4 h-4"></i></div>
                </div>
                <div id="node-3" class="node bg-[--bg-secondary] p-3 rounded-lg border border-[--border-primary] shadow-md w-48" style="left: 60%; top: 300px;">
                    <h3 class="font-semibold">伦理风险</h3>
                     <p class="text-xs text-[--text-secondary] mt-1 line-clamp-2">结论：涉及数据隐私、算法偏见等核心问题...</p>
                     <div class="add-node-btn"><i data-lucide="plus" class="w-4 h-4"></i></div>
                </div>
                <div id="node-4" class="node bg-[--bg-secondary] p-3 rounded-lg border border-[--border-primary] shadow-md w-48" style="left: 80%; top: 300px; transform: translateX(-100%);">
                    <h3 class="font-semibold">技术实现</h3>
                     <p class="text-xs text-[--text-secondary] mt-1 line-clamp-2">结论：依赖大模型、VR/AR及数据分析技术...</p>
                     <div class="add-node-btn"><i data-lucide="plus" class="w-4 h-4"></i></div>
                </div>
            </div>
        </div>

        <!-- 优化：侧边栏交互面板 -->
        <aside id="interaction-panel" class="w-[500px] bg-[--bg-secondary] border-l border-[--border-primary] flex-shrink-0 flex flex-col h-full absolute right-0 top-0 shadow-2xl">
            <div class="p-3 border-b border-[--border-primary] flex items-center justify-between flex-shrink-0">
                <h2 id="panel-title" class="text-lg font-bold">...</h2>
                <button id="close-panel-btn" class="p-1 hover:bg-[--bg-tertiary] rounded-full text-[--text-secondary] hover:text-[--text-primary]"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- 优化：结论区域，更清晰地体现“AI辅助下的用户终审”原则 -->
            <div class="p-3 border-b border-[--border-primary] flex-shrink-0">
                <label class="text-sm font-semibold text-[--text-secondary] flex items-center gap-2 mb-2">
                    <i data-lucide="milestone" class="w-4 h-4 text-[--accent]"></i>
                    本节点结论 (AI辅助草稿)
                </label>
                <div class="bg-[--bg-primary] p-3 rounded-lg border border-[--border-primary] focus-within:border-[--accent] transition-colors relative group">
                    <textarea id="conclusion-textarea" class="w-full bg-transparent text-[--text-primary] focus:outline-none resize-none" rows="3" placeholder="AI正在生成建议..."></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="ai-confidence" class="text-xs px-2 py-0.5 rounded-full transition-opacity"></span>
                        <!-- 优化：保存按钮更突出，引导用户交互 -->
                        <button id="save-conclusion-btn" class="text-sm bg-[--accent] text-white px-4 py-1.5 rounded-md hover:bg-[--accent-hover] font-semibold">保存结论</button>
                    </div>
                </div>
            </div>

            <div id="chat-area" class="flex-grow p-3 overflow-y-auto flex flex-col gap-4"></div>

            <div class="p-3 border-t border-[--border-primary] flex-shrink-0">
                <div class="bg-[--bg-primary] p-2 rounded-lg border border-[--border-primary] flex items-start gap-2 focus-within:border-[--accent]">
                    <textarea id="chat-input" placeholder="输入消息，或用 [[...]] 引用其他节点..." class="flex-grow bg-transparent focus:outline-none resize-none" rows="2"></textarea>
                    <button class="bg-[--accent] p-2 rounded-lg text-white mt-auto self-end hover:bg-[--accent-hover]"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </aside>

    </main>
    
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-40 backdrop-blur-sm"></div>

    <!-- 优化：全局洞察Modal，更精美的UI和更清晰的行动引导 -->
    <div id="insight-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-[--bg-secondary] w-full max-w-2xl rounded-lg shadow-2xl hidden z-50 border border-[--border-primary]">
        <div class="p-6 border-b border-[--border-primary]">
            <h2 class="text-2xl font-bold flex items-center gap-3"><i data-lucide="sparkles" class="text-[--accent]"></i>全局洞察</h2>
            <p class="text-[--text-secondary] mt-2">选择需整合的节点，并用一个“分析透镜”来激发AI的深度思考。</p>
        </div>
        
        <div class="p-6">
            <div id="quality-precheck" class="mb-4 bg-orange-900/50 border border-[--warning] text-orange-300 p-3 rounded-lg text-sm hidden">
                <h4 class="font-bold flex items-center gap-2"><i data-lucide="alert-triangle"></i>输入质量预检</h4>
                <p class="mt-1">发现您选择的部分节点结论较宽泛，可能影响洞察质量。</p>
                <div class="mt-2">
                    <button class="text-xs font-semibold bg-orange-500/20 hover:bg-orange-500/40 text-white py-1 px-3 rounded-md transition-colors">优化 [伦理风险] 结论</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-2">1. 选择节点</h3>
                    <div class="space-y-2 text-sm max-h-48 overflow-y-auto p-2 bg-[--bg-primary] rounded-lg border border-[--border-primary]">
                        <label class="flex items-center gap-2 p-2 hover:bg-[--bg-tertiary] rounded cursor-pointer"><input type="checkbox" class="accent-[--accent]"> 正面影响</label>
                        <label class="flex items-center gap-2 p-2 hover:bg-[--bg-tertiary] rounded cursor-pointer"><input type="checkbox" class="accent-[--accent]"> 负面影响</label>
                        <label class="flex items-center gap-2 p-2 hover:bg-[--bg-tertiary] rounded cursor-pointer"><input type="checkbox" class="accent-[--accent]" checked onchange="document.getElementById('quality-precheck').classList.remove('hidden')"> 伦理风险</label>
                        <label class="flex items-center gap-2 p-2 hover:bg-[--bg-tertiary] rounded cursor-pointer"><input type="checkbox" class="accent-[--accent]" checked> 技术实现</label>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">2. 选择分析透镜</h3>
                    <div class="grid grid-cols-1 gap-2 text-sm">
                        <button class="text-left p-3 bg-[--bg-tertiary] hover:border-[--accent] border border-transparent rounded-lg transition-all"><strong>核心矛盾分析</strong><p class="text-xs opacity-70">找出这些观点间最主要的冲突。</p></button>
                        <button class="text-left p-3 bg-[--bg-tertiary] hover:border-[--accent] border border-transparent rounded-lg transition-all"><strong>创新机会探索</strong><p class="text-xs opacity-70">组合这些想法，提出新方向。</p></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-2 p-4 bg-[--bg-primary]/50 flex justify-end gap-3 rounded-b-lg">
            <button id="cancel-insight-btn" class="bg-[--bg-tertiary] px-4 py-2 rounded-lg hover:opacity-80">取消</button>
            <button class="bg-[--accent] text-white px-4 py-2 rounded-lg hover:bg-[--accent-hover] flex items-center gap-2">
                <i data-lucide="zap"></i>启动分析 (消耗1点数)
            </button>
        </div>
    </div>
    
    <!-- 优化：引用搜索弹窗，增加预览功能 -->
    <div id="reference-popover" class="absolute bg-[--bg-tertiary] rounded-lg shadow-xl w-80 p-2 hidden z-30 border border-[--border-primary]">
        <input type="text" placeholder="搜索节点标题或结论..." class="w-full bg-[--bg-primary] p-2 rounded-md border border-[--border-primary] focus:outline-none focus:border-[--accent] mb-2">
        <div class="max-h-48 overflow-y-auto">
            <div class="p-2 hover:bg-[--bg-primary] rounded cursor-pointer">
                <h4 class="font-semibold text-sm">正面影响</h4>
                <p class="text-xs text-[--text-secondary] mt-1">结论：实现个性化学习路径，提升教学效率，并通过虚拟实验室降低实践成本。</p>
            </div>
             <div class="p-2 hover:bg-[--bg-primary] rounded cursor-pointer">
                <h4 class="font-semibold text-sm">负面影响</h4>
                <p class="text-xs text-[--text-secondary] mt-1">结论：可能加剧教育不公，产生技术依赖，并对学生的社交能力产生负面影响。</p>
            </div>
        </div>
    </div>

    <div id="nudge-alert" class="nudge fixed bottom-5 right-5 bg-[--bg-secondary] border border-[--border-primary] p-3 rounded-lg shadow-lg opacity-0 transform translate-y-5 flex items-center gap-3 z-20">
        <i data-lucide="lightbulb" class="text-[--warning]"></i>
        <p class="text-sm">准备好总结一下本阶段的发现了么？</p>
        <button id="nudge-action-btn" class="text-sm text-[--accent] font-bold hover:underline">去提炼</button>
        <button id="nudge-close-btn" class="p-1 text-[--text-secondary] hover:text-[--text-primary]"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <script>
        lucide.createIcons();
        
        // --- 核心数据与状态 ---
        const nodeData = {
            'node-root': { title: '课题：AI对未来教育模式的颠覆性影响', parent: null, children: ['node-1', 'node-2', 'node-3', 'node-4'] },
            'node-1': { title: '正面影响', parent: 'node-root', children: [], final_conclusion: '', ai_conclusion_draft: '核心结论是AI能通过个性化学习路径和虚拟实验室，极大提升教学效率和体验。', ai_conclusion_confidence: 'high', chat: [ { from: 'user', text: '我们来深入探讨一下AI对教育的正面影响。' }, { from: 'ai', text: '当然。最显著的优点是个性化学习。AI可以根据每个学生的学习进度、风格和薄弱环节，动态调整教学内容和难度，实现真正的因材施教。' } ] },
            'node-2': { title: '负面影响', parent: 'node-root', children: [], final_conclusion: '可能加剧教育不公，产生技术依赖...', ai_conclusion_draft: '主要负面影响包括加剧数字鸿沟、导致学生过度依赖技术而丧失批判性思维，以及对社交能力的潜在削弱。', ai_conclusion_confidence: 'medium', chat: [] },
            'node-3': { title: '伦理风险', parent: 'node-root', children: [], final_conclusion: '涉及数据隐私、算法偏见等核心问题...', ai_conclusion_draft: '主要风险围绕学生数据隐私安全、算法可能存在的偏见，以及对人类教师角色的冲击。', ai_conclusion_confidence: 'medium', chat: [ { from: 'user', text: '现在讨论伦理风险。我最关心的是学生数据隐私。' }, { from: 'ai', text: '这是一个核心问题。教学过程会产生大量敏感的学生数据，如何确保这些数据的安全、合规使用，防止滥用和泄露，是首要的伦理挑战。' }, { from: 'user', text: '如果我们需要整合其他节点的结论呢？比如我想参考一下 [[技术实现]] ' }, { from: 'ai', text: '很好的问题。当您引用 <span class="reference-capsule" data-node-id="node-4" data-context="依赖大模型、VR/AR及数据分析技术..."><i data-lucide="link-2" class="w-3 h-3"></i>@技术实现</span> 后，我就可以基于这个上下文进行分析：正是因为依赖大数据分析，所以隐私风险才如此巨大。我们需要在技术便利性和伦理边界之间找到平衡。' } ] },
            'node-4': { title: '技术实现', parent: 'node-root', children: [], final_conclusion: '依赖大模型、VR/AR及数据分析技术...', ai_conclusion_draft: '技术上主要依赖高性能的大语言模型、沉浸式VR/AR交互界面，以及强大的后台数据分析系统。', ai_conclusion_confidence: 'high', chat: [] }
        };
        let activeNodeId = null;

        // --- DOM元素获取 ---
        const dom = {
            canvas: document.getElementById('canvas'),
            svgLines: document.getElementById('svg-lines'),
            interactionPanel: document.getElementById('interaction-panel'),
            closePanelBtn: document.getElementById('close-panel-btn'),
            breadcrumbs: document.getElementById('breadcrumbs'),
            panelTitle: document.getElementById('panel-title'),
            conclusionTextarea: document.getElementById('conclusion-textarea'),
            aiConfidence: document.getElementById('ai-confidence'),
            chatArea: document.getElementById('chat-area'),
            chatInput: document.getElementById('chat-input'),
            referencePopover: document.getElementById('reference-popover'),
            nudgeAlert: document.getElementById('nudge-alert'),
            modalOverlay: document.getElementById('modal-overlay'),
            insightModal: document.getElementById('insight-modal'),
            insightBtn: document.getElementById('insight-btn'),
            cancelInsightBtn: document.getElementById('cancel-insight-btn'),
        };

        // --- 核心功能函数 ---
        
        /**
         * 优化：打开交互面板
         * - 实现了“默认编辑模式”的引导：自动聚焦文本区域
         * - 完整地更新UI状态
         */
        function openInteractionPanel(nodeId) {
            if (!nodeData[nodeId] || nodeId === 'node-root') return;
            activeNodeId = nodeId;
            const data = nodeData[nodeId];

            dom.interactionPanel.classList.add('open');
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            document.getElementById(nodeId)?.classList.add('active');
            
            updateBreadcrumbs();
            dom.panelTitle.textContent = data.title;
            
            // 结论区 - 体现"AI辅助下的用户终审"
            dom.conclusionTextarea.value = data.final_conclusion;
            dom.conclusionTextarea.placeholder = data.ai_conclusion_draft;
            updateConfidenceUI(data.ai_conclusion_confidence);

            // 关键交互：默认进入编辑模式，引导用户审阅 (原则一：自适应引导)
            setTimeout(() => dom.conclusionTextarea.focus(), 300); // 延迟聚焦以等待动画完成

            // 聊天区
            renderChat(data.chat);
        }

        function closeInteractionPanel() {
            dom.interactionPanel.classList.remove('open');
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            activeNodeId = null;
            updateBreadcrumbs();
        }

        /**
         * 新增：创建新节点的功能
         * @param {string} parentId - 父节点的ID
         */
        function createNewNode(parentId) {
            const parentElement = document.getElementById(parentId);
            if (!parentElement) return;

            const newNodeId = `node-${Date.now()}`;
            const parentData = nodeData[parentId];
            
            // 更新数据模型
            nodeData[newNodeId] = {
                title: '新节点',
                parent: parentId,
                children: [],
                final_conclusion: '',
                ai_conclusion_draft: '从这里开始，与AI探讨这个新话题...',
                ai_conclusion_confidence: 'medium',
                chat: []
            };
            parentData.children.push(newNodeId);

            // 创建DOM元素
            const nodeEl = document.createElement('div');
            nodeEl.id = newNodeId;
            nodeEl.className = 'node bg-[--bg-secondary] p-3 rounded-lg border border-[--border-primary] shadow-md w-48';
            
            // 随机定位在父节点下方
            const parentRect = parentElement.getBoundingClientRect();
            const canvasRect = dom.canvas.getBoundingClientRect();
            nodeEl.style.left = `${parentElement.offsetLeft + Math.random() * 100 - 50}px`;
            nodeEl.style.top = `${parentElement.offsetTop + parentRect.height + 80}px`;

            nodeEl.innerHTML = `
                <h3 class="font-semibold" contenteditable="true">新节点</h3>
                <p class="text-xs text-[--text-secondary] mt-1 line-clamp-2">结论：暂无</p>
                <div class="add-node-btn"><i data-lucide="plus" class="w-4 h-4"></i></div>
            `;
            dom.canvas.appendChild(nodeEl);
            lucide.createIcons({ nodes: [nodeEl.querySelector('.add-node-btn')] });

            // 重新绑定事件并重绘
            bindNodeEvents(nodeEl);
            drawAllLines();
            openInteractionPanel(newNodeId);
        }

        // --- UI更新与渲染 ---

        function updateBreadcrumbs() {
            if (activeNodeId && nodeData[activeNodeId]) {
                dom.breadcrumbs.innerHTML = `<button class="hover:text-[--text-primary]">项目根</button> <span class="text-[--text-secondary]">/</span> <span class="text-[--text-primary] font-semibold">${nodeData[activeNodeId].title}</span>`;
            } else {
                dom.breadcrumbs.innerHTML = `<button class="hover:text-[--text-primary] font-semibold">项目根</button>`;
            }
        }
        
        function updateConfidenceUI(confidence) {
            const confidenceMap = {
                high: { text: '【高精度稿】', class: 'bg-green-500/20 text-green-300' },
                medium: { text: '【建议审阅】', class: 'bg-orange-500/20 text-orange-300' },
                low: { text: '【发散性草稿】', class: 'bg-red-500/20 text-red-400' }
            };
            const config = confidenceMap[confidence] || confidenceMap.medium;
            dom.aiConfidence.textContent = config.text;
            dom.aiConfidence.className = `text-xs px-2 py-0.5 rounded-full transition-opacity ${config.class}`;
        }
        
        function renderChat(chatHistory) {
            dom.chatArea.innerHTML = '';
            chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', 'p-3', 'rounded-lg', 'max-w-md');
                if (msg.from === 'user') {
                    bubble.classList.add('bg-[--accent]', 'text-white', 'self-end', 'rounded-br-none');
                } else {
                    bubble.classList.add('bg-[--bg-tertiary]', 'self-start', 'rounded-bl-none');
                }
                bubble.innerHTML = msg.text;
                dom.chatArea.appendChild(bubble);
            });
            dom.chatArea.scrollTop = dom.chatArea.scrollHeight;
            lucide.createIcons({ nodes: dom.chatArea.querySelectorAll('.reference-capsule') });
        }

        function drawAllLines() {
            dom.svgLines.innerHTML = '';
            Object.keys(nodeData).forEach(childId => {
                const parentId = nodeData[childId].parent;
                if (!parentId) return;

                const parentEl = document.getElementById(parentId);
                const childEl = document.getElementById(childId);

                if (!parentEl || !childEl) return;
                
                const parentRect = parentEl.getBoundingClientRect();
                const childRect = childEl.getBoundingClientRect();
                const svgRect = dom.svgLines.getBoundingClientRect();

                const startX = parentRect.left - svgRect.left + parentRect.width / 2;
                const startY = parentRect.top - svgRect.top + parentRect.height;
                const endX = childRect.left - svgRect.left + childRect.width / 2;
                const endY = childRect.top - svgRect.top;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${startX} ${startY} C ${startX} ${startY + 60}, ${endX} ${endY - 60}, ${endX} ${endY}`);
                path.setAttribute('stroke', 'var(--border-primary)');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                dom.svgLines.appendChild(path);
            });
        }

        // --- 事件绑定 ---
        
        function bindNodeEvents(nodeElement) {
            // 点击节点打开面板
            nodeElement.addEventListener('click', (e) => {
                e.stopPropagation();
                openInteractionPanel(nodeElement.id);
            });
            // 点击添加按钮创建新节点
            const addBtn = nodeElement.querySelector('.add-node-btn');
            if(addBtn) {
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createNewNode(nodeElement.id);
                });
            }
        }

        document.querySelectorAll('.node').forEach(bindNodeEvents);
        
        dom.closePanelBtn.addEventListener('click', closeInteractionPanel);
        dom.canvas.addEventListener('click', (e) => {
            if (e.target.id === 'canvas') {
                closeInteractionPanel();
            }
        });
        
        dom.chatInput.addEventListener('input', () => {
            if (dom.chatInput.value.endsWith('[[')) {
                const inputRect = dom.chatInput.getBoundingClientRect();
                dom.referencePopover.style.left = `${inputRect.left}px`;
                dom.referencePopover.style.bottom = `${window.innerHeight - inputRect.top}px`;
                dom.referencePopover.classList.remove('hidden');
            } else {
                dom.referencePopover.classList.add('hidden');
            }
        });

        document.body.addEventListener('click', () => dom.referencePopover.classList.add('hidden'));
        dom.chatInput.addEventListener('click', e => e.stopPropagation());
        dom.referencePopover.addEventListener('click', e => e.stopPropagation());
        
        // Modal Logic
        dom.insightBtn.addEventListener('click', () => {
            dom.modalOverlay.classList.remove('hidden');
            dom.insightModal.classList.remove('hidden');
        });
        dom.cancelInsightBtn.addEventListener('click', () => {
            dom.modalOverlay.classList.add('hidden');
            dom.insightModal.classList.add('hidden');
        });
        
        // Nudge Logic (原则一：自适应引导)
        setTimeout(() => {
            if (!activeNodeId) {
                dom.nudgeAlert.classList.remove('opacity-0', 'translate-y-5');
            }
        }, 5000);
        document.getElementById('nudge-close-btn').addEventListener('click', () => dom.nudgeAlert.classList.add('opacity-0'));
        document.getElementById('nudge-action-btn').addEventListener('click', () => {
            dom.nudgeAlert.classList.add('opacity-0');
            openInteractionPanel('node-1');
        });

        // Context Expansion Logic (原则二：透明与可控)
        dom.chatArea.addEventListener('click', e => {
            const capsule = e.target.closest('.reference-capsule');
            if (capsule) {
                const existingContext = capsule.parentElement.querySelector('.reference-context');
                if (existingContext) {
                    existingContext.remove();
                    return;
                }
                const contextText = capsule.dataset.context;
                const contextDiv = document.createElement('div');
                contextDiv.className = 'reference-context text-sm text-[--text-secondary] rounded';
                contextDiv.innerHTML = `<p><i class="inline-block w-4 h-4" data-lucide="pilcrow"></i> 展开的上下文：</p><p class="mt-1 pl-5">"${contextText}"</p>`;
                capsule.insertAdjacentElement('afterend', contextDiv);
                lucide.createIcons({ nodes: [contextDiv] });
            }
        });

        // --- 初始化 ---
        window.addEventListener('load', () => {
            drawAllLines();
            updateBreadcrumbs();
        });
        window.addEventListener('resize', drawAllLines);

    </script>
</body>
</html>
