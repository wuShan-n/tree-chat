下面给出**“最佳的一种”评论模块 API 契约**：**HTTP REST（查询+命令）+ SSE 实时事件**。
理由：REST 易被各端消费、与网关/缓存生态兼容；SSE 足够覆盖“新评论/编辑/删除/反应”下发，部署与压测成本低于 WS；同时满足你“模块化边界清晰”的要求（不外键到用户/业务表）。

> 命名空间：`/api/comments/v1`
> 安全：推荐 **JWT**（由上游统一认证），模块仅读取声明（如 `sub`/`actor_id`/`actor_urn`/`roles`）。如过渡期，可用 `X-Actor-Id` / `X-Actor-URN` 头传入。
> 版本：路径版本（`/v1`）+ 响应头 `ETag` + 条件请求 `If-Match`。
> 幂等：写操作支持 `Idempotency-Key`。
> 错误：`application/problem+json`（RFC 7807 语义）。

---

# 1. 资源模型（对外 JSON）

## 1.1 Subject（业务对象在本模块的注册体）

```json
{
  "subject_id": "018f1b7d-6ba1-7a1e-b1f7-4f7c7a7f5c0a",
  "subject_key": "post:12345",
  "is_locked": false,
  "is_archived": false,
  "policy": { "max_depth": 6, "pre_moderation": false },
  "comment_count": 128,
  "visible_count": 120,
  "last_commented_at": "2025-10-20T05:01:02Z"
}
```

## 1.2 Comment

```json
{
  "id": 987654321,
  "subject_id": "018f1b7d-6ba1-7a1e-b1f7-4f7c7a7f5c0a",
  "root_id": 987654321,
  "parent_id": null,
  "depth": 0,
  "author": { "id": 42, "urn": "user:42" },
  "body_md": "Markdown text...",
  "body_html": "<p>Markdown text…</p>",
  "status": "published",
  "toxicity_score": 0.07,
  "counters": { "up": 12, "down": 1, "replies": 3 },
  "my_reaction": { "up": true, "down": false, "emoji": ["thumbs_up"] },
  "quality": { "best_score": 0.83, "hot_score": 0.41 },
  "collapsed": { "value": false, "reason": null },
  "created_at": "2025-10-20T05:00:00Z",
  "edited_at": null,
  "deleted_at": null
}
```

---

# 2. 认证与通用约定

* **Authorization**：`Authorization: Bearer <JWT>`（含 `sub`/`actor_id`/`actor_urn`/`roles`）。
  过渡可用：`X-Actor-Id`、`X-Actor-URN`。
* **幂等**：`Idempotency-Key: <uuid>`（POST/PUT/PATCH/DELETE）。
* **并发控制**：读响应附带 `ETag`；更新时带 `If-Match`。
* **分页**：**游标制**：`?limit=20&cursor=<opaque>`，响应体和 `Link: <...>; rel="next"`。
* **字段裁剪**（可选）：`?fields=id,body_html,counters`。
* **限流头**（建议）：`RateLimit-Limit/Remaining/Reset`。

---

# 3. Endpoints（契约）

## 3.1 Subject（仅在评论模块内）

**注册/幂等创建**

```
PUT /api/comments/v1/subjects/{subject_key}
Body: { "policy": { "max_depth": 6, "pre_moderation": false } }
Headers: Idempotency-Key
→ 200/201  返回 Subject
```

**获取与管理**

```
GET    /api/comments/v1/subjects/{subject_key|subject_id}
PATCH  /api/comments/v1/subjects/{subject_id}   Body: { "is_locked": true, "is_archived": false, "policy": {...} }
```

> 说明：业务侧仅需维护 `subject_key`（如 `post:12345`）。模块返回稳定的 `subject_id` 供后续调用。

---

## 3.2 评论读取（查询）

**列表：顶层评论（默认“最佳”）**

```
GET /api/comments/v1/subjects/{subject_id}/comments
  ?view=best|hot|new|old|controversial
  &limit=20&cursor=...
  &status=published            # 审核端可用: all|pending|hidden|deleted|spam
  &with_counts=true
  &with_my_reaction=true
```

**展开某楼层的子树**

```
GET /api/comments/v1/comments/{comment_id}/replies
  ?order=structure|chronological
  &limit=50&cursor=...
  &collapse_below=0.3          # 折叠低置信/低分，前端可选
```

**单条详情**

```
GET /api/comments/v1/comments/{comment_id}
```

---

## 3.3 评论写入（命令）

**创建评论（顶层/子评）**

```
POST /api/comments/v1/subjects/{subject_id}/comments
Headers: Idempotency-Key, Authorization
Body: {
  "parent_id": null | 123,
  "body_md": "text...",
  "status": "published" | "pending"    # 若策略为预审，可忽略为 pending
}
→ 201  返回 Comment（含 ETag）
```

**编辑评论（乐观并发）**

```
PATCH /api/comments/v1/comments/{id}
Headers: If-Match: "<ETag>"
Body: { "body_md": "new...", "status": "published|hidden|deleted|spam" }
→ 200  返回 Comment（新 ETag）
```

**删除评论**

```
DELETE /api/comments/v1/comments/{id}?soft=true
→ 204
```

---

## 3.4 反应（点赞/点踩/表情）

**设置/取消（幂等）**

```
PUT    /api/comments/v1/comments/{id}/reactions/up         Body: { "active": true|false }
PUT    /api/comments/v1/comments/{id}/reactions/down       Body: { "active": true|false }
PUT    /api/comments/v1/comments/{id}/reactions/emoji/{code}  Body: { "active": true|false }
GET    /api/comments/v1/comments/{id}/reactions/summary    # 聚合计数 & 我的反应
```

> 说明：用 **PUT+active** 取代“POST 创建、DELETE 取消”的二义性，天然幂等，易于重试。

---

## 3.5 举报 & 审核

**举报**

```
POST /api/comments/v1/comments/{id}/reports
Body: { "reason": "spam link", "metadata": {...} }
→ 201 { "report_id": 123 }
```

**审核队列（需角色：moderator）**

```
GET   /api/comments/v1/moderation/comments?status=pending&limit=50&cursor=...
POST  /api/comments/v1/moderation/comments/{id}:action
Body: { "action": "approve|hide|delete|spam|restore|shadow_ban", "reason": "..." }
→ 200 返回 moderation_action
```

---

## 3.6 统计与健康

```
GET /api/comments/v1/subjects/{subject_id}/metrics
→ { "comment_count": 128, "visible_count": 120, "top_contributors":[...], "p95_latency_ms": 18 }
```

---

## 3.7 实时事件（SSE）

```
GET /api/comments/v1/subjects/{subject_id}/events
Accept: text/event-stream
Query: ?since=2025-10-20T04:59:00Z&types=comment.created,comment.updated,comment.deleted,reaction.changed
```

**事件格式**

```text
event: comment.created
id: 174002
data: {"subject_id":"018f...","comment":{...}}

event: comment.updated
id: 174003
data: {"comment":{ "id": 987, "edited_at":"2025-10-20T05:02:00Z", ... }}

event: reaction.changed
id: 174004
data: {"comment_id":987, "summary":{"up":13,"down":1}, "actor":{"id":42}}
```

> 断线重连：客户端带 `Last-Event-ID` 继续；服务端保证事件按 Subject 严格递增。

---

# 4. 查询语义与排序细节

* `view=best`：按 **Wilson 下界**（预计算）降序，tie-breaker：`created_at DESC, id DESC`。
* `view=hot`：按 **HN 热度**降序，tie-breaker 同上。
* `view=new|old`：按时间（`created_at` 倒序/正序）。
* `view=controversial`（可选）：按高方差/接近 0.5 的正负比 + 样本量加权。
* `order=structure`：子树按结构序（父在前、子在后），支持分段虚拟渲染。
* **分页稳定性**：所有列表都返回 `next_cursor`；游标包含排序键+边界 id，避免插入导致的翻页抖动。

---

# 5. 错误模型（Problem+JSON）

```json
{
  "type": "https://errors.example.com/comments/subject-locked",
  "title": "Subject is locked",
  "status": 423,
  "detail": "Comments are locked for this subject.",
  "instance": "/api/comments/v1/subjects/018f.../comments",
  "meta": { "subject_id": "018f..." }
}
```

常见错误：

* 400 参数非法 / 最大深度超限
* 401/403 未认证 / 无权限（如非作者编辑、非版主审核）
* 404 资源不存在（subject/comment）
* 409 版本冲突（`If-Match` 不匹配）
* 423 Subject 锁定
* 429 限流（附带 `RateLimit-*`）

---

# 6. 契约示例

**创建顶层评论**

```http
POST /api/comments/v1/subjects/018f.../comments
Authorization: Bearer eyJhbGci...
Idempotency-Key: 57b2b5a2-1e1b-4f8f-9b9c-3a2d1f7b2f63
Content-Type: application/json

{ "body_md": "第一条评论！" }
```

```http
201 Created
ETag: "W/\"cmt-987654321-v1\""
Location: /api/comments/v1/comments/987654321

{ ...Comment JSON... }
```

**列出顶层（最佳排序）**

```http
GET /api/comments/v1/subjects/018f.../comments?view=best&limit=20
Authorization: Bearer eyJhbGci...
```

```json
{
  "items": [ { ... }, { ... } ],
  "next_cursor": "eyJzY29yZSI6MC44MywiY3JlYXRlZF9hdCI6IjIwMjUtMTAtMjBUMDU6MDA6MDBaIiwiaWQiOjk4N30="
}
```

**对评论点赞（幂等）**

```http
PUT /api/comments/v1/comments/987654321/reactions/up
Authorization: Bearer eyJhbGci...
Content-Type: application/json

{ "active": true }
```

```http
200 OK
{ "summary": { "up": 13, "down": 1 }, "my_reaction": { "up": true, "down": false } }
```

---

# 7. 权限与策略（建议）

* **作者可编辑窗口**：如 5–15 分钟；超时需版主权限或走“编辑历史”。
* **Subject 策略**：`policy.pre_moderation=true` 时，创建即 `pending`，仅审核后可见。
* **角色**：`comments:read`、`comments:write`、`comments:react`、`comments:report`、`comments:moderate`。
* **脱敏与安全**：服务端统一清洗 `body_html`（白名单），阻断脚本/内联事件；限制附件 mime/大小（如走单独对象存储）。

---

# 8. 对接建议（落地 Spring Boot）

* **控制器分包**：`SubjectController` / `CommentQueryController` / `CommentCommandController` / `ReactionController` / `ModerationController` / `EventStreamController`。
* **DTO 与映射**：`CommentEntity` → `CommentView`（拼装 counters、my_reaction、quality）；
* **ETag 生成**：`hash(id, updated_at/version)`；
* **SSE**：使用 `SseEmitter` 或 WebFlux `Flux<ServerSentEvent<...>>`；事件来自事务外盒→Kafka→推送。
* **OpenAPI**：建议基于本契约生成一个 3.1 规范文件，便于前后端与网关联调。

---

如果你需要，我可以**直接给出精简版 OpenAPI 3.1 YAML**（覆盖上面所有端点与模式），以及**SSE 最小可用控制器**代码（Spring WebFlux/Boot MVC 两版），你可以复制就用。
