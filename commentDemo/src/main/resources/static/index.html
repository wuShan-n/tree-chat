<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Comment Web API 测试台</title>
    <style>
        :root {
            color-scheme: light dark;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            margin: 0;
            padding: 0 0 48px;
            background: #f5f7fb;
            color: #1f2933;
        }
        header {
            background: linear-gradient(135deg, #2364aa, #81c3d7);
            color: #ffffff;
            padding: 28px 32px;
            margin-bottom: 24px;
        }
        header h1 {
            margin: 0 0 6px;
            font-size: 28px;
        }
        header p {
            margin: 0;
            font-size: 15px;
            max-width: 640px;
        }
        main {
            max-width: 1180px;
            margin: 0 auto;
            padding: 0 28px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            align-items: start;
        }
        section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px 22px;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.06);
        }
        section h2 {
            margin: 0 0 12px;
            font-size: 20px;
            color: #0f1c2e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        section h3 {
            margin: 18px 0 8px;
            font-size: 16px;
            color: #1f2933;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #334155;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.95);
            color: inherit;
        }
        textarea {
            min-height: 96px;
            resize: vertical;
            font-family: "JetBrains Mono", Consolas, monospace;
        }
        button {
            appearance: none;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            background: #2563eb;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        }
        button:hover {
            background: #1d4ed8;
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
        }
        button:active {
            transform: translateY(1px);
        }
        .button-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        .inline-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .highlight {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 16px;
            border: 1px dashed #94a3b8;
            font-size: 13px;
            line-height: 1.5;
        }
        .muted {
            color: #64748b;
            font-size: 13px;
        }
        .log-pane {
            grid-column: 1 / -1;
        }
        .log-output {
            background: #0f172a;
            color: #e2e8f0;
            padding: 18px;
            border-radius: 12px;
            height: 280px;
            overflow: auto;
            font-family: "JetBrains Mono", Consolas, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            border: 1px solid rgba(15, 23, 42, 0.45);
        }
        .result-output {
            background: #ffffff;
            border: 1px solid #dce2ed;
            border-radius: 10px;
            padding: 16px;
            height: 280px;
            overflow: auto;
            font-family: "JetBrains Mono", Consolas, monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .two-column {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            align-items: start;
        }
        @media (max-width: 1080px) {
            main {
                grid-template-columns: 1fr;
            }
            .log-pane {
                grid-column: auto;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>Comment Web API 测试台</h1>
    <p>用于快速调用 <code>/api/comments/v1</code> 下的 REST 接口，验证 <code>web</code> 包中的控制器功能。先配置请求上下文，再执行各类操作。</p>
</header>

<main>
    <section>
        <h2>请求设置</h2>
        <div class="highlight">
            设置基础路径与伪造的 Actor 头。当页面在同一应用域名下访问时，基础路径可留空。角色列表用逗号分隔。
        </div>
        <form id="settings-form">
            <label>
                基础路径（可为空，例如 <code>http://localhost:8080</code>）
                <input type="text" id="base-url" placeholder="/ 或 http://localhost:8080" value="">
            </label>
            <div class="inline-inputs">
                <label>
                    X-Actor-Id
                    <input type="text" id="actor-id" placeholder="如：1001">
                </label>
                <label>
                    X-Actor-Urn
                    <input type="text" id="actor-urn" placeholder="如：urn:user:1001">
                </label>
                <label>
                    X-Actor-Roles
                    <input type="text" id="actor-roles" placeholder="如：moderator,member">
                </label>
            </div>
            <div class="button-row">
                <button type="submit">保存设置</button>
                <button type="button" id="reset-settings" style="background:#64748b;">清空</button>
            </div>
        </form>
        <p class="muted" id="settings-status">尚未保存设置。</p>
    </section>

    <section>
        <h2>Subject 资源</h2>
        <form id="subject-upsert-form">
            <h3>创建 / 覆盖 Subject</h3>
            <label>
                subject_key
                <input type="text" id="subject-key" placeholder="必填，如：demo-article-1" required>
            </label>
            <label>
                请求体（JSON，可选）
                <textarea id="subject-upsert-body" placeholder='{"policy":{"allow_anonymous":true}}'></textarea>
            </label>
            <button type="submit">发送 PUT /subjects/{subjectKey}</button>
        </form>

        <form id="subject-get-by-key-form">
            <h3>按 subject_key 查询 Subject</h3>
            <label>
                subject_key
                <input type="text" id="subject-key-lookup" placeholder="如：demo-article-1" required>
            </label>
            <button type="submit">发送 GET /subjects/by-key/{subject_key}</button>
        </form>

        <form id="subject-get-by-id-form">
            <h3>按 subject_id 查询 Subject</h3>
            <label>
                subject_id（UUID）
                <input type="text" id="subject-id-lookup" placeholder="UUID" required>
            </label>
            <button type="submit">发送 GET /subjects/id/{subject_id}</button>
        </form>

        <form id="subject-patch-form">
            <h3>部分更新 Subject</h3>
            <label>
                subject_id（UUID）
                <input type="text" id="subject-id-patch" placeholder="UUID" required>
            </label>
            <label>
                请求体（JSON，可选）
                <textarea id="subject-patch-body" placeholder='{"is_locked":true}'></textarea>
            </label>
            <button type="submit">发送 PATCH /subjects/id/{subject_id}</button>
        </form>

        <form id="subject-metrics-form">
            <h3>获取 Subject 指标</h3>
            <label>
                subject_id（UUID）
                <input type="text" id="subject-id-metrics" placeholder="UUID" required>
            </label>
            <button type="submit">发送 GET /subjects/id/{subject_id}/metrics</button>
        </form>
    </section>

    <section>
        <h2>Comment 操作</h2>
        <form id="comment-create-form">
            <h3>创建评论</h3>
            <div class="inline-inputs">
                <label>
                    subject_id（UUID）
                    <input type="text" id="comment-subject-id" placeholder="必填" required>
                </label>
                <label>
                    parent_id（可选）
                    <input type="text" id="comment-parent-id" placeholder="顶级留空">
                </label>
            </div>
            <label>
                Markdown 内容（body_md）
                <textarea id="comment-body-md" placeholder="必填"></textarea>
            </label>
            <label>
                HTML 内容（body_html，可选）
                <textarea id="comment-body-html" placeholder="<p>可选</p>"></textarea>
            </label>
            <button type="submit">发送 POST /subjects/{subjectId}/comments</button>
        </form>

        <form id="comment-update-form">
            <h3>更新评论</h3>
            <label>
                comment_id
                <input type="text" id="comment-update-id" placeholder="必填" required>
            </label>
            <label>
                请求体（JSON）
                <textarea id="comment-update-body" placeholder='{"body_md":"更新后的内容"}'></textarea>
            </label>
            <div class="inline-inputs">
                <label>
                    If-Match（可选，用于乐观锁）
                    <input type="text" id="comment-if-match" placeholder="Etag 值">
                </label>
                <label>
                    自定义 Idempotency-Key
                    <input type="text" id="comment-idempotency" placeholder="POST 使用">
                </label>
            </div>
            <button type="submit">发送 PATCH /comments/{commentId}</button>
        </form>
    </section>

    <section>
        <h2>查询 &amp; Reaction</h2>
        <form id="comment-list-form">
            <h3>分页查询顶级评论</h3>
            <div class="inline-inputs">
                <label>
                    subject_id
                    <input type="text" id="list-subject-id" placeholder="UUID" required>
                </label>
                <label>
                    view
                    <input type="text" id="list-view" value="new">
                </label>
                <label>
                    limit
                    <input type="number" id="list-limit" value="20" min="1" max="100">
                </label>
                <label>
                    cursor
                    <input type="text" id="list-cursor" placeholder="可选">
                </label>
            </div>
            <button type="submit">发送 GET /subjects/{subjectId}/comments</button>
        </form>

        <form id="comment-get-form">
            <h3>查询单条评论</h3>
            <label>
                comment_id
                <input type="text" id="comment-get-id" placeholder="必填" required>
            </label>
            <button type="submit">发送 GET /comments/{commentId}</button>
        </form>

        <form id="comment-replies-form">
            <h3>查询子回复</h3>
            <div class="inline-inputs">
                <label>
                    comment_id
                    <input type="text" id="replies-comment-id" placeholder="必填" required>
                </label>
                <label>
                    order
                    <input type="text" id="replies-order" value="structure">
                </label>
                <label>
                    limit
                    <input type="number" id="replies-limit" value="50" min="1" max="200">
                </label>
                <label>
                    cursor
                    <input type="text" id="replies-cursor" placeholder="可选">
                </label>
            </div>
            <button type="submit">发送 GET /comments/{commentId}/replies</button>
        </form>

        <form id="reaction-toggle-form">
            <h3>切换 Reaction</h3>
            <div class="inline-inputs">
                <label>
                    comment_id
                    <input type="text" id="reaction-comment-id" placeholder="必填" required>
                </label>
                <label>
                    type
                    <select id="reaction-type">
                        <option value="up">up</option>
                        <option value="down">down</option>
                        <option value="emoji">emoji</option>
                    </select>
                </label>
                <label>
                    active
                    <select id="reaction-active">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </label>
            </div>
            <label>
                emoji_code（仅 emoji 模式需要）
                <input type="text" id="reaction-emoji" placeholder="如：U+1F600">
            </label>
            <button type="submit">发送 PUT /comments/{commentId}/reactions/{type}</button>
        </form>
    </section>

    <section class="log-pane">
        <h2>响应 &amp; 调用日志</h2>
        <div class="two-column">
            <pre class="result-output" id="result-view">等待请求...</pre>
            <pre class="log-output" id="log-view">=== 请求日志 ===
</pre>
        </div>
        <div class="button-row" style="margin-top:14px;">
            <button type="button" id="clear-log" style="background:#ef4444;">清空日志</button>
            <button type="button" id="copy-result" style="background:#10b981;">复制结果</button>
        </div>
    </section>
</main>

<script>
    const state = {
        baseUrl: '',
        headers: {}
    };

    const resultView = document.getElementById('result-view');
    const logView = document.getElementById('log-view');
    const settingsStatus = document.getElementById('settings-status');

    function normaliseBaseUrl(raw) {
        if (!raw) {
            return '';
        }
        return raw.endsWith('/') ? raw.slice(0, -1) : raw;
    }

    function buildUrl(path, query) {
        const base = state.baseUrl;
        const url = base ? base + path : path;
        if (!query) {
            return url;
        }
        const params = new URLSearchParams();
        Object.entries(query).forEach(([key, value]) => {
            if (value !== undefined && value !== null && value !== '') {
                params.append(key, value);
            }
        });
        const qs = params.toString();
        return qs ? url + '?' + qs : url;
    }

    function updateSettingsSummary() {
        const headerPairs = Object.entries(state.headers)
            .filter(([, value]) => value !== undefined && value !== null && value !== '')
            .map(([key, value]) => key + ': ' + value);
        const headerSummary = headerPairs.length ? headerPairs.join('、') : '无';
        const base = state.baseUrl || '（相对路径）';
        settingsStatus.textContent = `基础路径：${base} ｜ 已注入 Header：${headerSummary}`;
    }

    function appendLog(line) {
        const timestamp = new Date().toISOString();
        logView.textContent += `[${timestamp}] ${line}\n`;
        logView.scrollTop = logView.scrollHeight;
    }

    function showResult(title, payload) {
        const body = typeof payload === 'string'
            ? payload
            : JSON.stringify(payload, null, 2);
        resultView.textContent = `${title}\n\n${body}`;
    }

    function parseJsonInput(raw, fieldName) {
        if (!raw || raw.trim() === '') {
            return undefined;
        }
        try {
            return JSON.parse(raw);
        } catch (err) {
            throw new Error(`${fieldName} 不是合法 JSON：${err.message}`);
        }
    }

    async function sendRequest({method, path, body, query, extraHeaders, idempotencyKey, ifMatch}) {
        const url = buildUrl(path, query);
        const headers = new Headers();
        Object.entries(state.headers).forEach(([key, value]) => {
            if (value !== undefined && value !== null && value !== '') {
                headers.set(key, value);
            }
        });
        if (extraHeaders) {
            Object.entries(extraHeaders).forEach(([key, value]) => {
                if (value !== undefined && value !== null && value !== '') {
                    headers.set(key, value);
                }
            });
        }
        if (idempotencyKey) {
            headers.set('Idempotency-Key', idempotencyKey);
        }
        if (ifMatch) {
            headers.set('If-Match', ifMatch);
        }

        const options = { method, headers };
        if (body !== undefined) {
            headers.set('Content-Type', 'application/json');
            options.body = JSON.stringify(body);
        }

        appendLog(`➡️ ${method.toUpperCase()} ${url}`);
        if (body !== undefined) {
            appendLog(`   Request Body: ${JSON.stringify(body)}`);
        }

        try {
            const response = await fetch(url, options);
            const text = await response.text();
            let parsed = text;
            try {
                parsed = text ? JSON.parse(text) : null;
            } catch {
                // 保留原始文本
            }
            appendLog(`✅ 响应 ${response.status} ${response.statusText}`);
            showResult(`${method.toUpperCase()} ${url} → ${response.status}`, parsed ?? '(空响应)');
        } catch (error) {
            appendLog(`❌ 请求失败：${error.message}`);
            showResult('请求失败', error.stack || error.message);
            throw error;
        }
    }

    document.getElementById('settings-form').addEventListener('submit', (event) => {
        event.preventDefault();
        state.baseUrl = normaliseBaseUrl(document.getElementById('base-url').value.trim());
        state.headers = {
            'X-Actor-Id': document.getElementById('actor-id').value.trim(),
            'X-Actor-Urn': document.getElementById('actor-urn').value.trim(),
            'X-Actor-Roles': document.getElementById('actor-roles').value.trim()
        };
        updateSettingsSummary();
        appendLog('⚙️ 已更新请求设置。');
    });

    document.getElementById('reset-settings').addEventListener('click', () => {
        document.getElementById('base-url').value = '';
        document.getElementById('actor-id').value = '';
        document.getElementById('actor-urn').value = '';
        document.getElementById('actor-roles').value = '';
        state.baseUrl = '';
        state.headers = {};
        updateSettingsSummary();
        appendLog('🧹 已恢复默认设置。');
    });

    document.getElementById('subject-upsert-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const key = document.getElementById('subject-key').value.trim();
        if (!key) {
            alert('subject_key 不能为空');
            return;
        }
        let payload;
        try {
            payload = parseJsonInput(document.getElementById('subject-upsert-body').value, '请求体');
        } catch (err) {
            alert(err.message);
            return;
        }
        await sendRequest({
            method: 'PUT',
            path: `/api/comments/v1/subjects/${encodeURIComponent(key)}`,
            body: payload
        });
    });

    document.getElementById('subject-get-by-key-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const subjectKey = document.getElementById('subject-key-lookup').value.trim();
        if (!subjectKey) {
            alert('subject_key 不能为空');
            return;
        }
        await sendRequest({
            method: 'GET',
            path: `/api/comments/v1/subjects/by-key/${encodeURIComponent(subjectKey)}`
        });
    });

    document.getElementById('subject-get-by-id-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const subjectId = document.getElementById('subject-id-lookup').value.trim();
        if (!subjectId) {
            alert('subject_id 不能为空');
            return;
        }
        await sendRequest({
            method: 'GET',
            path: `/api/comments/v1/subjects/id/${encodeURIComponent(subjectId)}`
        });
    });

    document.getElementById('subject-patch-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const subjectId = document.getElementById('subject-id-patch').value.trim();
        if (!subjectId) {
            alert('subject_id 不能为空');
            return;
        }
        let payload;
        try {
            payload = parseJsonInput(document.getElementById('subject-patch-body').value, '请求体');
        } catch (err) {
            alert(err.message);
            return;
        }
        await sendRequest({
            method: 'PATCH',
            path: `/api/comments/v1/subjects/id/${encodeURIComponent(subjectId)}`,
            body: payload
        });
    });

    document.getElementById('subject-metrics-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const subjectId = document.getElementById('subject-id-metrics').value.trim();
        if (!subjectId) {
            alert('subject_id 不能为空');
            return;
        }
        await sendRequest({
            method: 'GET',
            path: `/api/comments/v1/subjects/id/${encodeURIComponent(subjectId)}/metrics`
        });
    });

    document.getElementById('comment-create-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const subjectId = document.getElementById('comment-subject-id').value.trim();
        const parentIdRaw = document.getElementById('comment-parent-id').value.trim();
        const bodyMd = document.getElementById('comment-body-md').value.trim();
        const bodyHtml = document.getElementById('comment-body-html').value.trim();
        if (!subjectId) {
            alert('subject_id 不能为空');
            return;
        }
        if (!bodyMd) {
            alert('body_md 不能为空');
            return;
        }
        const payload = {
            parent_id: parentIdRaw ? Number(parentIdRaw) : null,
            body_md: bodyMd,
            body_html: bodyHtml || undefined
        };
        await sendRequest({
            method: 'POST',
            path: `/api/comments/v1/subjects/${encodeURIComponent(subjectId)}/comments`,
            body: payload,
            idempotencyKey: document.getElementById('comment-idempotency').value.trim() || undefined
        });
    });

    document.getElementById('comment-update-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const commentId = document.getElementById('comment-update-id').value.trim();
        if (!commentId) {
            alert('comment_id 不能为空');
            return;
        }
        let payload;
        try {
            payload = parseJsonInput(document.getElementById('comment-update-body').value, '请求体');
        } catch (err) {
            alert(err.message);
            return;
        }
        if (payload === undefined) {
            alert('请求体不能为空');
            return;
        }
        await sendRequest({
            method: 'PATCH',
            path: `/api/comments/v1/comments/${encodeURIComponent(commentId)}`,
            body: payload,
            ifMatch: document.getElementById('comment-if-match').value.trim() || undefined
        });
    });

    document.getElementById('comment-list-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const subjectId = document.getElementById('list-subject-id').value.trim();
        if (!subjectId) {
            alert('subject_id 不能为空');
            return;
        }
        await sendRequest({
            method: 'GET',
            path: `/api/comments/v1/subjects/${encodeURIComponent(subjectId)}/comments`,
            query: {
                view: document.getElementById('list-view').value.trim(),
                limit: document.getElementById('list-limit').value,
                cursor: document.getElementById('list-cursor').value.trim()
            }
        });
    });

    document.getElementById('comment-get-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const commentId = document.getElementById('comment-get-id').value.trim();
        if (!commentId) {
            alert('comment_id 不能为空');
            return;
        }
        await sendRequest({
            method: 'GET',
            path: `/api/comments/v1/comments/${encodeURIComponent(commentId)}`
        });
    });

    document.getElementById('comment-replies-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const commentId = document.getElementById('replies-comment-id').value.trim();
        if (!commentId) {
            alert('comment_id 不能为空');
            return;
        }
        await sendRequest({
            method: 'GET',
            path: `/api/comments/v1/comments/${encodeURIComponent(commentId)}/replies`,
            query: {
                order: document.getElementById('replies-order').value.trim(),
                limit: document.getElementById('replies-limit').value,
                cursor: document.getElementById('replies-cursor').value.trim()
            }
        });
    });

    document.getElementById('reaction-toggle-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const commentId = document.getElementById('reaction-comment-id').value.trim();
        if (!commentId) {
            alert('comment_id 不能为空');
            return;
        }
        const type = document.getElementById('reaction-type').value;
        const active = document.getElementById('reaction-active').value === 'true';
        const emojiCode = document.getElementById('reaction-emoji').value.trim();
        const payload = {
            active,
            emoji_code: emojiCode || undefined
        };
        await sendRequest({
            method: 'PUT',
            path: `/api/comments/v1/comments/${encodeURIComponent(commentId)}/reactions/${encodeURIComponent(type)}`,
            body: payload
        });
    });

    document.getElementById('clear-log').addEventListener('click', () => {
        logView.textContent = '=== 请求日志 ===\n';
        appendLog('🧹 日志已清空。');
    });

    document.getElementById('copy-result').addEventListener('click', async () => {
        if (!navigator.clipboard) {
            alert('当前浏览器不支持剪贴板写入。');
            return;
        }
        try {
            await navigator.clipboard.writeText(resultView.textContent);
            appendLog('📋 已复制结果到剪贴板。');
        } catch (err) {
            appendLog('⚠️ 复制失败：' + err.message);
            alert('复制失败：' + err.message);
        }
    });

    updateSettingsSummary();
</script>
</body>
</html>
